# v1.1 Prompt Ready for A/B Testing

## Date: 2025-11-15

## Status: âœ… Ready for Testing

All preparation work for v1.1 part prompt testing is complete. This document summarizes what was done and provides next steps.

---

## What We Accomplished

### 1. Root Cause Analysis âœ…

**Identified**: Part Cycle Coherence failure (2/4) is the primary issue

**Evidence**:
- Baseline test (story_-Uiw58GxHJMSaLA2) showed only 2 of 5 phases generated
- phasesPresent: ["setup", "adversity"]
- Missing phases: virtue, consequence, transition
- This single failure cascades to lower Cyclic Structure (79%) and Intrinsic Motivation (75%)

**Impact**:
- part.cycleCoherence: 2/4 (FAILED)
- Cyclic Structure: 79% (needs improvement)
- Intrinsic Motivation: 75% (needs improvement)

### 2. v1.1 Prompt Design âœ…

**Created**: Complete v1.1 part prompt with explicit 5-phase cycle requirements

**Key Changes from v1.0**:

1. **Added 5-Phase Cycle Output Validation Section**
   - Explicit requirement for ALL 5 phases
   - Phase-by-phase description with requirements
   - Validation checklist for AI to verify output

2. **Updated User Template**
   - Required structure with phase labels
   - Explicit format showing all 5 phases
   - Pre-finalization validation instruction

3. **Added Complete Working Example**
   - Full 5-phase cycle demonstration ("The Last Garden")
   - Shows natural language within structured headings
   - Demonstrates proper causal links between phases

**Location**: `prompts/v1.1/part-prompt.ts`

### 3. Prompt Version Tracking System âœ…

**Created**: Directory structure and documentation for systematic versioning

**Structure**:
```
prompts/
â”œâ”€â”€ README.md              # Version history and usage guide
â”œâ”€â”€ v1.0/                  # Baseline (reference only)
â”œâ”€â”€ v1.1/                  # 5-phase cycle fix
â”‚   â””â”€â”€ part-prompt.ts     # Improved prompt
â””â”€â”€ v1.2/                  # Future iterations
```

**Documentation**: `prompts/README.md`
- Version history with metrics
- Versioning strategy
- Development workflow
- Usage examples

### 4. A/B Test Configuration âœ…

**Verified**: A/B test script exists and is ready to use

**Location**: `ab-test.ts`

**Features**:
- Loads or generates stories for both versions
- Performs statistical analysis (t-test, p-value)
- Generates comparison report
- Makes recommendation (ADOPT/REVISE/REVERT)

**Command**:
```bash
pnpm tsx tests/iteration-testing/novels/ab-test.ts \
  --control v1.0 \
  --experiment v1.1 \
  --prompts "last-garden,broken-healer" \
  --sample-size 5 \
  --hypothesis "Part cycle coherence increases to 4/4"
```

### 5. Design Documentation âœ…

**Created**: Comprehensive design document for v1.1

**Location**: `PART_PROMPT_V1.1_DESIGN.md`

**Contents**:
- Hypothesis statement
- Root cause analysis
- Solution design with before/after comparisons
- Expected impact on metrics
- Implementation plan
- Risk assessment
- Timeline

---

## Expected Improvements

### Hypothesis

**"Adding explicit 5-phase cycle validation to the part generation prompt will increase part.cycleCoherence from 2/4 to 4/4, raising Cyclic Structure from 79% to 92% and Intrinsic Motivation from 75% to 85%"**

### Predicted Metrics

| Metric | v1.0 Baseline | v1.1 Expected | Delta |
|--------|---------------|---------------|-------|
| part.cycleCoherence | 2.0/4 | 4.0/4 | +2.0 |
| Cyclic Structure | 79% | 92% | +13% |
| Intrinsic Motivation | 75% | 85% | +10% |

### Success Criteria

- âœ… part.cycleCoherence mean â‰¥3.5/4 in v1.1 stories
- âœ… phasesCount = 5 in â‰¥80% of v1.1 stories
- âœ… Cyclic Structure â‰¥85%
- âœ… Statistical significance: p-value < 0.05
- âœ… No regression in other Core Principles

---

## Next Steps

### Immediate (Day 1): Implement Version Support

1. **Update Prompt Manager** (`src/lib/studio/generators/prompt-manager.ts`)
   ```typescript
   export class PromptManager {
     getPrompt(
       type: 'story' | 'part' | 'chapter' | 'scene',
       options?: { version?: string }
     ): { system: string; userTemplate: string } {
       const version = options?.version || 'v1.0';

       if (type === 'part' && version === 'v1.1') {
         // Import and return v1.1 part prompt
         const { partPromptV1_1 } = require('../../tests/iteration-testing/novels/prompts/v1.1/part-prompt');
         return partPromptV1_1;
       }

       return this.prompts[type];  // Default v1.0
     }
   }
   ```

2. **Update Part Generator** (`src/lib/studio/generators/part-generator.ts`)
   ```typescript
   export async function generatePart(options: {
     partNumber: number;
     storyContext: string;
     promptVersion?: string;  // Add version parameter
   }) {
     const promptManager = new PromptManager();
     const prompt = promptManager.getPrompt('part', {
       version: options.promptVersion || 'v1.0'
     });
     // ... rest of generation logic
   }
   ```

3. **Update Evaluation Suite** (`run-evaluation-suite.ts`)
   ```typescript
   // Add version parameter to generation calls
   const story = await generateStory({
     prompt: testPrompt.prompt,
     partPromptVersion: options.version || 'v1.0'  // Pass version
   });
   ```

### Week 1: Run A/B Test

1. **Generate v1.0 Baseline Stories** (if not already sufficient)
   ```bash
   pnpm tsx tests/iteration-testing/novels/run-evaluation-suite.ts \
     --version v1.0 \
     --prompts "last-garden,broken-healer" \
     --iterations 5 \
     --mode thorough
   ```

2. **Generate v1.1 Experiment Stories**
   ```bash
   pnpm tsx tests/iteration-testing/novels/run-evaluation-suite.ts \
     --version v1.1 \
     --prompts "last-garden,broken-healer" \
     --iterations 5 \
     --mode thorough
   ```

3. **Run A/B Comparison**
   ```bash
   pnpm tsx tests/iteration-testing/novels/ab-test.ts \
     --control v1.0 \
     --experiment v1.1 \
     --prompts "last-garden,broken-healer" \
     --sample-size 5 \
     --hypothesis "Part cycle coherence increases to 4/4"
   ```

4. **Analyze Results**
   - Review statistical significance (p < 0.05?)
   - Check part.cycleCoherence scores
   - Verify all 5 phases present in characterArcs
   - Check for regressions in other metrics

### Week 1: Decision Point

**If v1.1 succeeds** (hypothesis supported, p < 0.05):
1. âœ… Promote v1.1 to default in prompt manager
2. âœ… Update baseline documentation with new metrics
3. âœ… Move to next iteration (v1.2 - character virtue evaluation)
4. âœ… Update SESSION_SUMMARY.md with results

**If v1.1 fails** (hypothesis not supported):
1. ðŸ“Š Analyze failure patterns
   - Which phases are still missing?
   - Is the prompt too rigid or too flexible?
   - Did the model follow the structure but generate poor content?
2. ðŸ”§ Design v1.2 with refined approach
   - Adjust example quality
   - Modify validation checklist
   - Simplify or clarify instructions
3. ðŸ”„ Repeat A/B test cycle

---

## Files Created/Modified

### Created Files

1. **`prompts/v1.1/part-prompt.ts`**
   - Complete v1.1 part prompt with 5-phase cycle validation
   - 350+ lines of system prompt + user template
   - Includes full working example

2. **`prompts/README.md`**
   - Version history and tracking documentation
   - Development workflow guide
   - Usage examples

3. **`PART_PROMPT_V1.1_DESIGN.md`**
   - Comprehensive design document
   - Root cause analysis
   - Solution design
   - Expected impact and timeline

4. **`V1.1_READY_FOR_TESTING.md`** (this document)
   - Summary of preparation work
   - Next steps
   - Implementation guide

### Files to Modify (Next Steps)

1. **`src/lib/studio/generators/prompt-manager.ts`**
   - Add version parameter support
   - Implement v1.1 prompt loading

2. **`src/lib/studio/generators/part-generator.ts`**
   - Accept promptVersion parameter
   - Pass to prompt manager

3. **`tests/iteration-testing/novels/run-evaluation-suite.ts`**
   - Pass version to generation functions

---

## Documentation Reference

| Document | Purpose | Location |
|----------|---------|----------|
| **Design Document** | v1.1 rationale and design | `PART_PROMPT_V1.1_DESIGN.md` |
| **Prompt Version Guide** | Version history and usage | `prompts/README.md` |
| **v1.1 Prompt Code** | Actual improved prompt | `prompts/v1.1/part-prompt.ts` |
| **Baseline Results** | v1.0 performance data | `BASELINE_V1.0_RESULTS.md` |
| **Iteration Strategy** | 12-week improvement plan | `ITERATION_STRATEGY.md` |
| **Session Summary** | Implementation progress | `SESSION_SUMMARY.md` |
| **A/B Test Script** | Testing tool | `ab-test.ts` |

---

## Key Metrics to Watch

### Primary Metrics (Hypothesis Target)

| Metric | Threshold | Target | Current v1.0 |
|--------|-----------|--------|--------------|
| part.cycleCoherence | 3.0/4 | 4.0/4 | 2.0/4 âŒ |
| phasesCount | 5 | 5 | 2 âŒ |
| allPhasesDistinct | true | true | false âŒ |

### Secondary Metrics (Impact Cascade)

| Metric | Threshold | Target | Current v1.0 |
|--------|-----------|--------|--------------|
| Cyclic Structure | 85% | 92% | 79% âš ï¸ |
| Intrinsic Motivation | 85% | 85% | 75% âš ï¸ |

### Guardrail Metrics (No Regression)

| Metric | Threshold | Current v1.0 | Must Stay â‰¥ |
|--------|-----------|--------------|-------------|
| Earned Consequence | 85% | 85% âœ… | 82% |
| Character Transformation | 85% | 94% âœ… | 82% |
| Emotional Resonance | 85% | 87% âœ… | 82% |
| Chapter Single Cycle Focus | 3.0/4 | 4.0/4 âœ… | 3.5/4 |
| Scene Cycle Alignment | 3.0/4 | 3.5/4 âœ… | 3.0/4 |

---

## Timeline

| Phase | Duration | Tasks | Status |
|-------|----------|-------|--------|
| **Preparation** | Day 0 | Design v1.1, create prompts, documentation | âœ… Complete |
| **Implementation** | Day 1 | Update prompt manager, part generator | ðŸ“‹ Next |
| **Generation** | Day 2-3 | Generate 10 stories (5 per version) | â³ Pending |
| **Analysis** | Day 4 | Run A/B test, statistical analysis | â³ Pending |
| **Decision** | Day 5 | ADOPT/REVISE/REVERT decision | â³ Pending |

**Estimated Time to Decision**: 5 days

---

## Risk Mitigation

### Risk 1: Model Doesn't Follow Structured Format

**Likelihood**: Medium
**Impact**: High
**Mitigation**:
- Provided complete working example with natural language
- Used clear section headers (CYCLE PHASE 1, 2, 3...)
- Validation checklist to guide AI behavior

### Risk 2: Output Quality Decreases

**Likelihood**: Low
**Impact**: High
**Mitigation**:
- Guardrail metrics (no regression in other Core Principles)
- Example shows high-quality content within structure
- A/B test will catch quality issues

### Risk 3: Statistical Significance Not Achieved

**Likelihood**: Medium
**Impact**: Medium
**Mitigation**:
- Sample size of 5 per version (total 10 stories)
- Can increase sample size if borderline (p â‰ˆ 0.05-0.10)
- Clear success criteria defined upfront

---

## Success Definition

**v1.1 is considered successful if**:

1. âœ… **Hypothesis Supported**: part.cycleCoherence mean â‰¥3.5/4 in v1.1
2. âœ… **Statistical Significance**: p-value < 0.05
3. âœ… **Phase Completeness**: â‰¥80% of stories have all 5 phases
4. âœ… **No Major Regressions**: All guardrail metrics stay above thresholds
5. âœ… **Practical Improvement**: Cyclic Structure â‰¥85% or +5% improvement

**If all criteria met**: Promote v1.1 to default, proceed to v1.2 (character virtue evaluation)

**If any criteria fails**: Analyze root cause, design v1.2 with fixes, repeat A/B test

---

**Status**: âœ… v1.1 design complete, ready for implementation and testing

**Last Updated**: 2025-11-15 18:30 UTC
